<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parcel Tracking</title>
    <!-- Leafletjs mapping links and scripts -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/track.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/man.css') }}">
    <style>
        #map { height: 350px; }
    </style>
</head>
<body>
	{% include 'header.html' %}
    <!-- Search bar -->
    <div class="row justify-content-center">
	    {% with messages = get_flashed_messages(with_categories=true) %}
	    {% if messages %}
	    {% for category, message in messages %}
	    <div class="alert alert-{{ category }}">
		    {{ message }}
	    </div>
	    {% endfor %}
	    {% endif %}
	    {% endwith %}

    </div>
    <div class="container mt-4">
	    <div class="row justify-content-center">
		    <div class="col-md-6">
			    <div class="input-group">
				    <input type="text" class="form-control" placeholder="Enter Tracking Number" id="trackingNumberInput">
				    <div class="input-group-append">
					    <button class="btn btn-primary" type="button" id="trackButton">
						    <span>Track</span>
					    </button>
				    </div>
			    </div>
		    </div>
        </div>
    </div>

    <!-- Tracking progress bar -->
    <div class="container px-1 px-md-4 py-5 mx-auto">
        <div class="card">
            <div class="row d-flex justify-content-between px-3 top">
                <div class="d-flex">
                    <h5>PARCEL: <span class="text-primary font-weight-bold" id="trackingNumberPlaceholder">Insert Tracking Number </span></h5>
                </div>
                <div class="d-flex flex-column text-sm-right">
                    <p class="mb-0">Expected Arrival: <span id="expectedArrivalPlaceholder">Always Atleast a Day</span></p>
                </div>
            </div>
            <!-- Add class 'active' to progress -->
            <div class="row d-flex justify-content-center">
                <div class="col-12">
                    <ul id="progressbar" class="text-center no-gutters">
                        <li id="step1" class="step0"></li>
                        <li id="step2" class="step0"></li>
                        <li id="step3" class="step0"></li>
                        <li id="step4" class="step0"></li>
                        <li id="step5" class="step0"></li>
                    </ul>
                </div>
            </div>
            <div class="row justify-content-between top">
                <div class="row d-flex icon-content">
                    <img class="icon" src="../static/images/arrive.png">
                    <div class="d-flex flex-column">
                        <p class="font-weight-bold">Pending<br>Allocation</p>
                    </div>
                </div>
                <div class="row d-flex icon-content">
                    <img class="icon" src="../static/images/rider.png">
                    <div class="d-flex flex-column">
                        <p class="font-weight-bold">Rider<br>Allocated</p>
                    </div>
                </div>
                <div class="row d-flex icon-content">
                    <img class="icon" src="../static/images/ship.png">
                    <div class="d-flex flex-column">
                        <p class="font-weight-bold">Pending<br>Pick-up</p>
                    </div>
                </div>
                <div class="row d-flex icon-content">
                    <img class="icon" src="../static/images/road.png">
                    <div class="d-flex flex-column">
                        <p class="font-weight-bold">Parcel<br>En Route</p>
                    </div>
                </div>
                <div class="row d-flex icon-content">
                    <img class="icon" src="../static/images/delivered.png">
                    <div class="d-flex flex-column">
                        <p class="font-weight-bold">Parcel<br>Arrived</p>
                    </div>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </div>
    <!-- Footer -->
    {% include 'footer.html' %}
    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var map = L.map('map').setView([-1.286389, 36.817223], 13);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);
});

document.getElementById('tracking-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const trackingNumber = document.getElementById('tracking-number').value;
        fetch(`/get_parcel_status?tracking_number=${trackingNumber}`)
            .then(response => response.json())
            .then(data => {
                let resultDiv = document.getElementById('result');
                resultDiv.innerHTML = '';
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color:red;">${data.error}</p>`;
                } else {
                    resultDiv.innerHTML = `
                        <h2>Parcel Status</h2>
                        <p>Status: ${data.status}</p>
                        <p>Expected Arrival: ${data.expected_arrival}</p>
                        <p>Pickup Location: ${data.pickup_location}</p>
                        <p>Delivery Location: ${data.delivery_location}</p>
                    `;
                    if (data.pickup_lat && data.pickup_lng && data.delivery_lat && data.delivery_lng) {
                        initializeMap(data.pickup_lat, data.pickup_lng, data.delivery_lat, data.delivery_lng);
                    } else {
                        document.getElementById('map').style.display = 'none';
                    }
                }
            })
            .catch(error => {
                document.getElementById('result').innerHTML = `<p style="color:red;">Error: ${error.message}</p>`;
            });
    });

    function initializeMap(pickupLat, pickupLng, deliveryLat, deliveryLng) {
        document.getElementById('map').style.display = 'block';

        const map = L.map('map').setView([pickupLat, pickupLng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const pickupMarker = L.marker([pickupLat, pickupLng]).addTo(map)
            .bindPopup('Pickup Location').openPopup();

        const deliveryMarker = L.marker([deliveryLat, deliveryLng]).addTo(map)
            .bindPopup('Delivery Location');

        const routeLine = L.polyline([[pickupLat, pickupLng], [deliveryLat, deliveryLng]], {color: 'blue'}).addTo(map);

        map.fitBounds(routeLine.getBounds());
    }

</script>

    <script>
document.getElementById('trackButton').addEventListener('click', function() {
    var trackingNumber = document.getElementById('trackingNumberInput').value;

    fetch('/get_parcel_status?tracking_number=' + trackingNumber)
        .then(response => response.json())
        .then(parcel => {
            if (parcel && parcel.status) {
		var expected_arrival = parcel.expected_arrival;
                updateProgressBar(parcel.status);
                updateTrackingInfo(trackingNumber, expected_arrival);
            } else {
                console.log('Parcel not found or status missing');
            }
        })
        .catch(error => {
            console.error('Error fetching parcel status:', error);
        });
});

function updateProgressBar(status) {
    // Reset progress bar to initial state
    document.querySelectorAll('#progressbar li').forEach(li => {
        li.classList.remove('active');
    });

    // Update progress bar based on parcel status
    switch (status) {
        case 'pending':
            document.getElementById('step1').classList.add('active');
            break;
        case 'allocated':
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.add('active');
            break;
        case 'in_progress':
            document.getElementById('step1').classList.add('active');
	    document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.add('active');
            break;
        case 'shipped':
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.add('active');
            document.getElementById('step4').classList.add('active');
            break;
        case 'arrived':
            document.getElementById('step1').classList.add('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('step3').classList.add('active');
            document.getElementById('step4').classList.add('active');
            document.getElementById('step5').classList.add('active');
            break;
        default:
            console.log('Unknown parcel status:', status);
            break;
    }
}

function updateTrackingInfo(trackingNumber, expectedArrival) {
    // Update tracking number and expected arrival time in HTML
    document.getElementById('trackingNumberPlaceholder').textContent = trackingNumber;
    document.getElementById('expectedArrivalPlaceholder').textContent = expectedArrival;
}
</script>
</body>
</html>
